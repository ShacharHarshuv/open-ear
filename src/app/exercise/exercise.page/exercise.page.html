<ion-header [translucent]="true">
  <ion-toolbar [color]="'primary'">
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>
    <ion-title (click)="onTitleClick()"> {{ state.name }}</ion-title>
    <ion-buttons slot="end">
      <ion-button
        (click)="editSettings()"
        [bdcWalkTriggerFor]="taskEditSettings"
      >
        <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
      </ion-button>
      <ion-button id="menu-button">
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
      <ion-popover trigger="menu-button" side="bottom" [dismissOnSelect]="true">
        <ng-template>
          <ion-list>
            <ion-item (click)="resetStatistics()" button>
              Reset statistics
            </ion-item>
            @if (state.exercise.explanation) {
            <ion-item (click)="exerciseExplanation.openExplanation()" button>
              Help
            </ion-item>
            }
          </ion-list>
        </ng-template>
      </ion-popover>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" [padding]="true">
  <div class="exercise__content-container" cdkDropListGroup>
    <section>
      @if (!state.globalSettings().answerQuestionAutomatically) {
      <p class="exercise__stats-container">
        Correct answers: {{ state.totalCorrectAnswers() }}/{{
        state.totalQuestions() }} ({{ correctAnswersPercentage() | number:
        '1.0-2' }}%)
      </p>
      } @if (state.info) {
      <p class="exercise__info">{{ state.info }}</p>
      }
    </section>
    <div class="exercise__answers-container">
      @for (answersPlayedTogether of (getCurrentAnswersLayout | pureFunction:
      state.currentAnswers()); track answersPlayedTogether) {
      <div>
        @for (answer of answersPlayedTogether; track answer) {
        <app-answer-indication
          [answerDisplay]="answer.answer && state.answerToLabelStringMap[answer.answer]"
          [isFocused]="state.currentlyPlayingSegments.has(answer.index)"
          [wasAnsweredWrong]="answer.wasWrong"
          cdkDropList
          [cdkDropListData]="answer.index"
        ></app-answer-indication>
        }
      </div>
      }
    </div>
    <app-answers-layout
      [answerList]="state.answerList()"
      [buttonTemplate]="answerButton"
      [multiAnswerButtonTemplate]="multiAnswerButton"
      [multiAnswerCellConfig]="{
        dismissOnSelect: true,
        triggerAction: 'hold',
      }"
      (answerSelected)="onAnswerSelected($event)"
    ></app-answers-layout>
    <div class="video-container"></div>
    <ng-template let-answerConfig #answerButton>
      <div cdkDropList>
        @if (answerConfig.answer; as answer) {
        <app-answer-button
          cdkDrag
          [cdkDragData]="answerConfig"
          (cdkDragDropped)="onDragDropped($event)"
          [disabled]="!state.isAnswerEnabled()"
          [right]="answer === rightAnswer()"
          [highlighted]="answer === state.highlightedAnswer()"
          [wrong]="wrongAnswers().includes(answer)"
        >
          <ng-container *cdkDragPlaceholder></ng-container>
          <span [innerHTML]="answerConfig.displayLabel"></span>
        </app-answer-button>
        }
      </div>
    </ng-template>
    <ng-template let-multiAnswerCell #multiAnswerButton>
      <app-multi-answer-button [multiAnswerCell]="multiAnswerCell" />
    </ng-template>
    <div class="exercise__actions-container">
      <ion-button
        [disabled]="!state.playerReady"
        (click)="state.playCurrentCadenceAndQuestion()"
      >
        <ion-icon name="repeat"></ion-icon>
        Repeat
      </ion-button>
      @if (state.hasCadence) {
      <ion-button
        [disabled]="!state.playerReady"
        (click)="state.playCurrentQuestion()"
      >
        <ion-icon name="musical-note"></ion-icon>
      </ion-button>
      }
      <ion-button
        [disabled]="!state.isQuestionCompleted"
        (click)="state.nextQuestion()"
      >
        Next
      </ion-button>
    </div>
  </div>
</ion-content>

<!--Walk-through popups-->
<bdc-walk-popup
  [header]="'Tip!'"
  name="taskEditSettings"
  #taskEditSettings
  [mustCompleted]="{taskViewExplanation: true}"
  [showButton]="true"
>
  Click here for more options and to adjust difficulty level
</bdc-walk-popup>
